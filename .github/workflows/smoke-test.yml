# =============================================================================
# OSCR Smoke Test - GitHub Actions
# =============================================================================
# Manual workflow to verify self-hosted runner functionality.
# Trigger manually from Actions tab after registering a runner.

name: Self-Hosted Smoke Test

on:
  workflow_dispatch:
    inputs:
      runner_labels:
        description: 'Runner labels (comma-separated)'
        required: false
        default: 'self-hosted,linux'

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ${{ fromJson(format('[{0}]', inputs.runner_labels || 'self-hosted,linux')) }}

    steps:
      - name: Runner Information
        run: |
          echo "=== Runner Information ==="
          echo "Hostname: $(hostname)"
          echo "User: $(whoami)"
          echo "Working Directory: $(pwd)"
          echo "OS: $(uname -a)"
          echo ""
          echo "=== Environment ==="
          echo "RUNNER_NAME: ${RUNNER_NAME:-not set}"
          echo "RUNNER_OS: ${RUNNER_OS:-not set}"
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE:-not set}"

      - name: Verify Non-Root Execution
        run: |
          echo "=== Security Check ==="
          if [ "$(id -u)" -eq 0 ]; then
            echo "ERROR: Running as root!"
            exit 1
          fi
          echo "OK: Running as non-root user (uid=$(id -u))"

      - name: Verify Docker Access
        run: |
          echo "=== Docker Check ==="
          docker --version
          docker info --format '{{.ServerVersion}}'
          echo "OK: Docker is accessible"

      - name: Docker Build Test
        run: |
          echo "=== Docker Build Test ==="
          cat > /tmp/Dockerfile <<'EOF'
          FROM alpine:latest
          RUN echo "Hello from OSCR smoke test"
          EOF
          docker build -t oscr-smoke-test:latest /tmp
          echo "OK: Docker build succeeded"

      - name: Docker Run Test
        run: |
          echo "=== Docker Run Test ==="
          docker run --rm oscr-smoke-test:latest echo "Container executed successfully"
          echo "OK: Docker run succeeded"

      - name: Cleanup
        run: |
          echo "=== Cleanup ==="
          docker rmi oscr-smoke-test:latest || true
          echo "OK: Cleanup completed"

      - name: Summary
        run: |
          echo ""
          echo "========================================="
          echo "  OSCR Smoke Test: PASSED"
          echo "========================================="
          echo ""
          echo "Your self-hosted runner is working correctly."
          echo ""
          echo "Runner: $(hostname)"
          echo "User: $(whoami)"
          echo "Docker: $(docker --version)"
