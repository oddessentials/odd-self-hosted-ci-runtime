# =============================================================================
# Mirror Azure DevOps Agent to GitHub Releases
# =============================================================================
# Downloads Azure Pipelines agent from Azure CDN and uploads to this repo's
# GitHub Releases. This avoids DNS dependency on vstsagentpackage.azureedge.net
# during regular CI builds.
#
# Usage:
#   1. Trigger manually via workflow_dispatch
#   2. Enter the agent version (e.g., 3.248.0)
#   3. Workflow downloads from Azure CDN and creates a release
#
# The prefetch script then downloads from GitHub releases (DNS-stable).

name: Mirror Agent

on:
  workflow_dispatch:
    inputs:
      agent_version:
        description: 'Azure Pipelines agent version (e.g., 3.248.0)'
        required: true
        type: string

env:
  AGENT_VERSION: ${{ inputs.agent_version }}

jobs:
  mirror:
    name: Mirror Agent v${{ inputs.agent_version }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download from Azure CDN
        run: |
          echo "Downloading Azure Pipelines agent v${AGENT_VERSION}..."
          curl -fsSL --retry 5 --retry-delay 10 --retry-all-errors \
            -o "vsts-agent-linux-x64-${AGENT_VERSION}.tar.gz" \
            "https://vstsagentpackage.azureedge.net/agent/${AGENT_VERSION}/vsts-agent-linux-x64-${AGENT_VERSION}.tar.gz"
          ls -lh "vsts-agent-linux-x64-${AGENT_VERSION}.tar.gz"

      - name: Verify download
        run: |
          echo "Verifying tarball..."
          tar -tzf "vsts-agent-linux-x64-${AGENT_VERSION}.tar.gz" > /dev/null
          echo "Tarball verified successfully"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: agent-v${{ env.AGENT_VERSION }}
          name: Azure Pipelines Agent v${{ env.AGENT_VERSION }}
          body: |
            Mirrored Azure Pipelines agent binary for network-independent Docker builds.

            **Source:** `https://vstsagentpackage.azureedge.net/agent/${{ env.AGENT_VERSION }}/vsts-agent-linux-x64-${{ env.AGENT_VERSION }}.tar.gz`

            **Usage:** This release is automatically consumed by `scripts/prefetch-ado-agent.sh`
          files: vsts-agent-linux-x64-${{ env.AGENT_VERSION }}.tar.gz
          fail_on_unmatched_files: true

      - name: Summary
        run: |
          echo "### Agent Mirrored Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${AGENT_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** https://github.com/${{ github.repository }}/releases/tag/agent-v${AGENT_VERSION}" >> $GITHUB_STEP_SUMMARY
